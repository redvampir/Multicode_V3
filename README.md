# Multicode

## Обзор
Multicode V3 — редактор исходного кода, который объединяет текстовое и визуальное представления программ. Пользователь может свободно переключаться между режимами и работать с дополнительными метаданными без изменения логики кода.

## Архитектура
- **Backend (Rust, Tauri):** парсинг файлов через tree-sitter, хранение и обработка метаданных, управление плагинами.
- **Frontend (Vite, JavaScript):** интерфейс с Monaco‑редактором и canvas‑основанным редактором блоков.
- **Связь компонентов:** локальный WebSocket‑сервер синхронизирует состояния между частями приложения.

## Ключевые возможности
- Переключение между текстовым и визуальным режимами.
- Сохранение метаданных в комментариях к исходному коду.
- Поддержка плагинов для расширения набора блоков.
- Работа с несколькими языками программирования.

## Структура метакомментариев
Служебная информация сохраняется в комментариях `@VISUAL_META` в формате JSON. Общая структура:
```json
{
  "id": "уникальный идентификатор блока",
  "x": координатаX,
  "y": координатаY,
  "note": "произвольный текст"
}
```
Комментарий не влияет на выполнение программы и может быть удалён при экспорте.

## Установка окружения
1. **Node.js**
   - Скачайте пакет с [nodejs.org](https://nodejs.org) или установите через менеджер `nvm`:
     ```bash
     nvm install --lts
     ```
2. **Rust**
   - Установите через `rustup`:
     ```bash
     curl https://sh.rustup.rs -sSf | sh
     ```
   - После установки перезапустите терминал и выполните `rustc --version`.
3. **Tauri CLI**
   - Проект использует конфигурацию **Tauri v2**. Установите CLI версии 2:
     ```bash
     npm install -g @tauri-apps/cli@^2
     ```
   - Либо через Cargo:
     ```bash
     cargo install tauri-cli --version ^2
     ```
   - Если установлен CLI версии 1, команда `npm run dev` завершится ошибками вида
     «`identifier` is a required property» и «Additional properties are not allowed».
     Удалите старую версию и поставьте CLI v2.
   - Проверьте установку командой `tauri --version`.

## Инструкции по запуску и сборке
1. Установите зависимости и выполните тесты:
   ```
   cd frontend && npm install && npm test
   cd ../backend && cargo test
   ```
2. Запуск режима разработки (после добавления корневого скрипта `dev` доступен из корня репозитория):
   ```
   npm run dev
   ```
   или из каталога `frontend`:
   ```
   cd frontend && npm run dev
   ```
3. Сборка десктопного приложения:
   ```
   cd frontend
   npm run build
   ```
   Скомпилированные бинарные файлы появятся в `frontend/src-tauri/target/release`.

## Использование CLI
Бэкенд содержит минимальный интерфейс командной строки для работы с кодом и метаданными. Примеры запуска:

```
cargo run -- parse path/to/file.rs --lang rust
cargo run -- export input.rs output.rs --strip-meta
cargo run -- meta list path/to/file.rs
cargo run -- meta fix path/to/file.rs
cargo run -- meta remove path/to/file.rs
```

## Добавление модулей
Плагины позволяют добавлять новые блоки и функциональность. Минимальный
пример расположен в [examples/plugins](examples/plugins) и имеет следующую
структуру:

```
examples/plugins/
├── my_plugin.rs     — backend-часть
├── my-block.js      — frontend-часть
└── README.md
```

### Пошаговое создание плагина
1. Скопируйте структуру каталога из примера или создайте аналогичный
   набор файлов.
2. **Backend:** реализуйте трейт [`Plugin`](backend/src/plugins/mod.rs),
   возвращающий `BlockDescriptor` с описанием нового блока.
3. Подключите плагин на серверной стороне и соберите проект.
4. **Frontend:** реализуйте модуль с функцией `register({ Block,
   registerBlock })`, в которой объявите класс блока и вызовете
   `registerBlock`.
5. Передайте путь к модулю в `loadBlockPlugins`, например
   `loadBlockPlugins(['./my-block.js'])`.

### Тестирование плагинов
- Запускайте `cargo test` в каталоге backend для проверки серверной части.
- Выполняйте `npm test` в каталоге frontend, чтобы убедиться в корректной
  работе визуальной компоненты.
- Для интеграционной проверки запускайте приложение командой
  `npm run dev` и убедитесь, что новый блок отображается без ошибок.

## Словарь
- **Блок:** визуальное представление участка кода.
- **Метакомментарий:** комментарий `@VISUAL_META` с координатами и прочими данными.
- **Плагин:** набор расширений для добавления новых блоков.

## Структура репозитория
- `backend` — серверная часть на Rust.
- `frontend` — интерфейс и клиентская логика.
- `plugins` — встроенные плагины и механизм их загрузки.
- `examples` — примеры плагинов и использования.
- `logs` — временные файлы и журналы backend (файлы вида `backend.log.YYYY-MM-DD`).

## Лицензия
Проект распространяется по лицензии MIT. Полный текст приведён в файле [LICENSE](LICENSE).
