# Multicode Desktop

Десктопная версия Multicode работает полностью автономно и не требует запуска web‑сервера на `localhost`.

Основные термины описаны в [docs/glossary.md](docs/glossary.md).
JSON-схема мета-комментария `@VISUAL_META` описана в [docs/sync.md](docs/sync.md#json-schema-visual_meta).

## Обновления

- Добавлен `ASTParser`, формирующий `SyntaxTree` с полем `visual_id` для синхронизации текстового и визуального редакторов.
- Поддержаны новые языки (C, C++, Java, C#) — при работе с парсером необходимо явно передавать `Lang`.
- Появился `ConflictResolver`, автоматически разрешающий расхождения между текстом и блок‑схемой на основе `ResolutionPolicy`.

## Оглавление

- [Разработка](#разработка)
- [Настройки и привязки](#настройки-и-привязки)
- [Сочетания клавиш](#сочетания-клавиш)
- [Скрипты упаковки](#скрипты-упаковки)
- [Расположение данных во время работы](#расположение-данных-во-время-работы)
- [Включение логов при отладке](#включение-логов-при-отладке)

## Разработка

1. Установите [Rust](https://www.rust-lang.org) и [Node.js](https://nodejs.org).
2. В корне проекта выполните:

   ```sh
   npm install
   npm run setup
   ```

3. Запустите приложение:

   ```sh
   npm run desktop:start
   # или напрямую через Cargo
   cargo run -p desktop
   ```

   При необходимости дополнительные функции ядра можно подключать через флаги, например `--features "git,watch"`.

   После запуска появится окно выбора проекта (Project Picker).
   Если ранее уже был открыт проект, он загрузится автоматически.
   Чтобы открыть каталог проекта вручную, нажмите кнопку **Open folder / Открыть папку** и выберите нужную директорию.
   Для открытия проекта на основе отдельного файла нажмите **Open file / Открыть файл** и укажите нужный файл.
   Чтобы сменить текущий проект, воспользуйтесь кнопкой **Open another project / Открыть другой проект** на главном экране — она возвращает к Project Picker.

   Например, чтобы начать работу с каталогом `~/projects/demo`, откройте Project Picker,
   нажмите **Open folder**, затем выберите `~/projects/demo`.

В панели инструментов доступны кнопки **Meta search**, **Export** и **Settings**,
которые выполняют поиск метаданных, сохраняют очищенный исходный код и запускают скрипт настроек соответственно.

4. Запустите тесты командной палитры:

   ```sh
   cargo test -p desktop command_palette
   ```

## Настройки и привязки

Окно настроек доступно из главного окна приложения — нажмите кнопку **Settings / Настройки**.
Все параметры сохраняются в файле `settings.json` в системном каталоге конфигурации,
например `~/.config/multicode/multicode/settings.json`.

В блоке **Sync / Синхронизация** можно настроить поведение движка:

- **Conflict resolution / Разрешение конфликтов** (`ConflictResolutionMode`) —
  определяет, какая версия метаданных используется при расхождениях между
  текстом и блок‑схемой. Доступны режимы:
  - `PreferText` — принимать текстовую версию (значение по умолчанию);
  - `PreferVisual` — принимать визуальную версию.
- **Сохранять формат мета‑комментариев** (`preserve_meta_formatting`) — при
  обновлении кода оставляет исходное оформление комментариев `@VISUAL_META`.

Эти параметры доступны через **Settings / Настройки** → **Sync / Синхронизация** —
выберите режим в выпадающем списке и переключите флажок.
Конфигурация записывается в `settings.json` и может выглядеть так:

```json
{
  "sync": {
    "conflict_resolution": "PreferVisual",
    "preserve_meta_formatting": false
  }
}
```

Чтобы изменить привязки клавиш, отредактируйте раздел `hotkeys` в этом файле.
Каждый хоткей описывается полями `key`, `ctrl`, `alt` и `shift`,
формирующими комбинацию без учёта регистра символов.
Для буквенных клавиш рекомендуется использовать хотя бы один модификатор
(`Ctrl`, `Alt` или `Shift`).

Каждая комбинация должна быть уникальной: при совпадении нескольких привязок
будет выполнено только первое подходящее действие. После изменения файла
перезапустите приложение.

## Сочетания клавиш

Приложение обрабатывает стандартные сочетания клавиш для работы с файлами.
По умолчанию доступны следующие комбинации:

| Действие             | Сочетание |
| -------------------- | --------- |
| Создание файла       | `Ctrl+N`  |
| Сохранение файла     | `Ctrl+S`  |
| Переключение режимов | `Ctrl+Tab` |
| Переименование файла | `F2`      |
| Удаление файла       | `Del`     |

Эти сочетания можно изменить через раздел [«Настройки и привязки»](#настройки-и-привязки).

## Скрипты упаковки

Все артефакты сохраняются в каталоге `dist/`.

### Windows

```sh
iscc scripts/installer.iss
```

### macOS

```sh
bash scripts/macos_bundle.sh
```

### Linux (AppImage)

```sh
bash scripts/build_appimage.sh
```

## Расположение данных во время работы

- Настройки пользователя: системный каталог конфигурации, например `~/.config/multicode/multicode/settings.json`.
- Журналы: системный каталог данных, `multicode/logs/debug.log` (например `~/.local/share/multicode/logs/debug.log`).

Эти пути определяются автоматически через стандартные механизмы ОС.

## Включение логов при отладке

Для вывода подробной отладочной информации установите переменную окружения
`RUST_LOG` перед запуском приложения:

```sh
RUST_LOG=desktop=trace cargo run -p desktop
```

Сообщения будут выводиться в консоль и сохраняться в `multicode/logs/debug.log`.

