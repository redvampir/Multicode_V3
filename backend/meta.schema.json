{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "VisualMeta",
  "description": "Metadata stored inside `@VISUAL_META` comments.",
  "type": "object",
  "required": [
    "id",
    "x",
    "y"
  ],
  "properties": {
    "version": {
      "description": "Schema version of this metadata.",
      "default": 1,
      "type": "integer",
      "format": "uint32",
      "minimum": 0.0
    },
    "id": {
      "description": "Identifier linking this metadata to AST nodes.",
      "type": "string"
    },
    "x": {
      "description": "X coordinate on the canvas.",
      "type": "number",
      "format": "double"
    },
    "y": {
      "description": "Y coordinate on the canvas.",
      "type": "number",
      "format": "double"
    },
    "tags": {
      "description": "Optional tags associated with this block.",
      "default": [],
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "links": {
      "description": "Optional links to other blocks.",
      "default": [],
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "tests": {
      "description": "Optional test commands to run for this block.",
      "default": [],
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "extends": {
      "description": "Optional identifier of a base metadata this entry extends.",
      "default": null,
      "type": [
        "string",
        "null"
      ]
    },
    "origin": {
      "description": "Optional reverse path to the original external file.",
      "default": null,
      "type": [
        "string",
        "null"
      ]
    },
    "translations": {
      "description": "Optional translations for block labels.",
      "default": {},
      "type": "object",
      "additionalProperties": {
        "type": "string"
      }
    },
    "ai": {
      "description": "Optional AI-generated note.",
      "default": null,
      "anyOf": [
        { "$ref": "#/definitions/AiNote" },
        { "type": "null" }
      ]
    },
    "extras": {
      "description": "Optional plugin-specific metadata.",
      "default": null
    },
    "history": {
      "description": "Previous states of this metadata.",
      "default": [],
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "timestamp": { "type": "string", "format": "date-time" },
          "snapshot": { "type": "object" }
        },
        "required": ["timestamp", "snapshot"],
        "additionalProperties": false
      }
    },
    "node": {
      "description": "Optional serialized visual node.",
      "default": null,
      "anyOf": [
        { "$ref": "#/definitions/VizNode" },
        { "type": "null" }
      ]
    },
    "updated_at": {
      "description": "Timestamp of last update in UTC.",
      "default": "1970-01-01T00:00:00Z",
      "type": "string",
      "format": "date-time"
    }
  },
  "additionalProperties": false,
  "definitions": {
    "AiNote": {
      "description": "Additional notes provided by AI.",
      "type": "object",
      "properties": {
        "description": {
          "description": "Optional description generated by AI.",
          "type": [
            "string",
            "null"
          ]
        },
        "hints": {
          "description": "Optional hints helping the user.",
          "default": [],
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "additionalProperties": false
    },
    "VizPort": {
      "type": "object",
      "required": ["id", "kind", "dir"],
      "properties": {
        "id": { "type": "string" },
        "kind": { "type": "string", "enum": ["exec", "data"] },
        "dir": { "type": "string", "enum": ["in", "out"] }
      },
      "additionalProperties": false
    },
    "ArrayNewNode": {
      "type": "object",
      "required": ["kind", "ports"],
      "properties": {
        "kind": { "const": "Array/New" },
        "ports": {
          "type": "array",
          "items": { "$ref": "#/definitions/VizPort" },
          "minItems": 3,
          "maxItems": 3
        }
      },
      "additionalProperties": false
    },
    "ArrayGetNode": {
      "type": "object",
      "required": ["kind", "ports"],
      "properties": {
        "kind": { "const": "Array/Get" },
        "ports": {
          "type": "array",
          "items": { "$ref": "#/definitions/VizPort" },
          "minItems": 5,
          "maxItems": 5
        }
      },
      "additionalProperties": false
    },
    "ArraySetNode": {
      "type": "object",
      "required": ["kind", "ports"],
      "properties": {
        "kind": { "const": "Array/Set" },
        "ports": {
          "type": "array",
          "items": { "$ref": "#/definitions/VizPort" },
          "minItems": 6,
          "maxItems": 6
        }
      },
      "additionalProperties": false
    },
    "MapNewNode": {
      "type": "object",
      "required": ["kind", "ports"],
      "properties": {
        "kind": { "const": "Map/New" },
        "ports": {
          "type": "array",
          "items": { "$ref": "#/definitions/VizPort" },
          "minItems": 3,
          "maxItems": 3
        }
      },
      "additionalProperties": false
    },
    "MapGetNode": {
      "type": "object",
      "required": ["kind", "ports"],
      "properties": {
        "kind": { "const": "Map/Get" },
        "ports": {
          "type": "array",
          "items": { "$ref": "#/definitions/VizPort" },
          "minItems": 5,
          "maxItems": 5
        }
      },
      "additionalProperties": false
    },
    "MapSetNode": {
      "type": "object",
      "required": ["kind", "ports"],
      "properties": {
        "kind": { "const": "Map/Set" },
        "ports": {
          "type": "array",
          "items": { "$ref": "#/definitions/VizPort" },
          "minItems": 6,
          "maxItems": 6
        }
      },
      "additionalProperties": false
    },
    "VizNode": {
      "oneOf": [
        { "$ref": "#/definitions/ArrayNewNode" },
        { "$ref": "#/definitions/ArrayGetNode" },
        { "$ref": "#/definitions/ArraySetNode" },
        { "$ref": "#/definitions/MapNewNode" },
        { "$ref": "#/definitions/MapGetNode" },
        { "$ref": "#/definitions/MapSetNode" }
      ]
    }
  }
}
