<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multicode Editor</title>
  <!-- Styles for the hotkey help dialog -->
  <link rel="stylesheet" href="./hotkeys.css" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #visual-canvas { width: 100%; height: 50vh; border: 1px solid #ccc; display: block; }
    #visual-minimap { position: fixed; bottom: 10px; right: 10px; width: 200px; height: 150px; border: 1px solid #ccc; background: #fff; opacity: 0.8; }
    #editor-wrapper { display: flex; height: 40vh; }
    #editor { flex: 1; border: 1px solid #ccc; }
    #preview { flex: 1; border: 1px solid #ccc; border-left: none; overflow: auto; display: none; padding: 0.5rem; }
    #text-minimap { width: 60px; height: 100%; border: 1px solid #ccc; border-left: none; }
    #outline { width: 200px; height: 100%; border: 1px solid #ccc; border-left: none; overflow: auto; }
    #controls { padding: 0.5rem; }
    #git-panel { padding: 0.5rem; border-top: 1px solid #ccc; }
    #git-log { white-space: pre-wrap; background: #f5f5f5; max-height: 20vh; overflow: auto; padding: 0.5rem; }
    .cm-invalid-meta { text-decoration: wavy underline red; }
    .cm-editor { font-size: var(--editor-font-size); line-height: var(--editor-line-height); }
    #search-panel { padding: 0.5rem; border-top: 1px solid #ccc; }
    #todo-panel { padding: 0.5rem; border-top: 1px solid #ccc; }
    #search-results { width: 100%; }
    #split-container { height: 100vh; }
    #textPane, #visualPane { flex: 1; }
    body.split #split-container { display: flex; }
    body:not(.split) #textPane { display: none; }
    body.split #textPane { display: block; }
  </style>
  <script type="module">
    import { EditorState } from "@codemirror/state";
    import { EditorView, keymap, drawSelection } from "@codemirror/view";
    import { foldGutter } from "@codemirror/language";
    import { foldKeymap, addSelection } from "https://cdn.jsdelivr.net/npm/@codemirror/commands@6.8.1/dist/index.js";
    import { basicSetup } from "https://cdn.jsdelivr.net/npm/@codemirror/basic-setup@0.20.0/dist/index.js";
    import { autocompletion as autocomplete } from "https://cdn.jsdelivr.net/npm/@codemirror/autocomplete@6.18.6/dist/index.js";
    import { invoke } from "https://cdn.jsdelivr.net/npm/@tauri-apps/api@1.5.0/tauri.js";
    import { save as saveDialog } from "https://cdn.jsdelivr.net/npm/@tauri-apps/api@1.5.0/dialog.js";
    import { VisualCanvas, VIEW_STATE_KEY } from "./visual/canvas.js";
    import { languageFromFilename, loadLanguage, mimeFromFilename } from "./shared/mime-map.js";
    import { loadBlockPlugins } from "./visual/blocks.js";
    import { insertVisualMeta, visualMetaHighlighter, visualMetaTooltip, foldMetaBlock, visualMetaMessenger, scrollToMeta, addBlockToolbar, refreshBlockCount, listMetaIds } from "./editor/visual-meta.js";
    import { registerHotkeys, setCanvas } from "./visual/hotkeys.ts";
    import { setCanvas as setExportCanvas } from "./visual/export.ts";
    import { registerCommandPalette } from "./editor/command-palette.ts";
    import { gotoLine } from "./editor/goto-line.js";
    import { gotoRelated } from "./editor/navigation.js";
    import { formatCurrentFile } from "../../scripts/format.js";
    import { customSource, setBlockIds } from "./editor/autocomplete.js";
    import settings from "../settings.json" assert { type: 'json' };
    import { availableThemes, applyTheme, getThemeName } from "./visual/theme.ts";
    import { writeTextFile, BaseDirectory } from "https://cdn.jsdelivr.net/npm/@tauri-apps/api@1.5.0/fs.js";
    import { searchAll, highlightResults, gotoResult } from "./shared/search.js";
    import { emit } from "./shared/event-bus.js";
    import { attachMinimap } from "./editor/minimap.ts";
    import { attachOutline } from "./editor/outline.ts";
    import { addSnapshot, showHistory } from "./editor/history.js";
    import { spellcheck } from "./editor/spellcheck.js";
    import { activeBlock } from "./editor/active-block.js";
    import { todoHighlight, updateTodoPanel } from "./editor/todo-highlight.js";
    import { attachGitBlame } from "./editor/git-blame.js";
    import { setLanguage, getLanguage, availableLanguages, getLanguageName } from "./shared/i18n.ts";
    import { startTutorial } from "./tutorial/index.ts";
    import { enablePreview, disablePreview, updatePreview } from "./editor/preview.js";

    const editorCfg = settings.editor || {};
    setLanguage(settings.language || 'en');
    document.documentElement.style.setProperty('--editor-font-size', `${editorCfg.fontSize || 14}px`);
    document.documentElement.style.setProperty('--editor-line-height', `${editorCfg.lineHeight || 20}px`);

    const editorSizing = EditorView.theme({
      "&": {
        fontSize: "var(--editor-font-size)",
        lineHeight: "var(--editor-line-height)"
      }
    });

    const TEXT_CURSOR_KEY = 'text-cursor-pos';
    let view;
    let removeMinimap;
    let removeOutline;
    let removeBlame;

    await loadBlockPlugins(window.blockPlugins || []);

    const canvasEl = document.getElementById('visual-canvas');
    const minimapEl = document.getElementById('visual-minimap');
    const vc = new VisualCanvas(canvasEl, minimapEl);
    const textMinimapEl = document.getElementById('text-minimap');
    const outlineEl = document.getElementById('outline');

    const storedView = localStorage.getItem(VIEW_STATE_KEY);
    if (storedView) {
      try {
        const { offset, scale } = JSON.parse(storedView);
        if (offset && typeof offset.x === 'number' && typeof offset.y === 'number') {
          vc.offset = offset;
        }
        if (typeof scale === 'number') vc.scale = scale;
        vc.draw();
      } catch (_) {}
    }

    setCanvas(vc);
    setExportCanvas(vc);
    registerHotkeys();
    registerCommandPalette([
      { id: 'gotoLine', title: 'Go to Line', run: () => gotoLine(view) },
      { id: 'gotoRelated', title: 'Go to Related File', run: () => gotoRelated(view) },
      { id: 'formatCurrentFile', title: 'Format Current File', run: () => formatCurrentFile() }
    ]);

    const themeSelect = document.getElementById('theme');
    availableThemes.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      if (t === getThemeName()) opt.selected = true;
      themeSelect.appendChild(opt);
    });
    themeSelect.addEventListener('change', async e => {
      const name = e.target.value;
      applyTheme(name);
      settings.visual = settings.visual || {};
      settings.visual.theme = name;
      await writeTextFile('settings.json', JSON.stringify(settings, null, 2), { dir: BaseDirectory.Resource });
    });

    const localeSelect = document.getElementById('locale');
    availableLanguages().forEach(l => {
      const opt = document.createElement('option');
      opt.value = l;
      opt.textContent = getLanguageName(l);
      if (l === getLanguage()) opt.selected = true;
      localeSelect.appendChild(opt);
    });
    localeSelect.addEventListener('change', async e => {
      const lang = e.target.value;
      setLanguage(lang);
      currentLocale = lang;
      vc.setLocale(lang);
      settings.language = lang;
      await writeTextFile('settings.json', JSON.stringify(settings, null, 2), { dir: BaseDirectory.Resource });
    });

    const fontSizeInput = document.getElementById('font-size');
    const lineHeightInput = document.getElementById('line-height');
    fontSizeInput.value = editorCfg.fontSize || 14;
    lineHeightInput.value = editorCfg.lineHeight || 20;
    fontSizeInput.addEventListener('input', async e => {
      const val = e.target.value;
      document.documentElement.style.setProperty('--editor-font-size', `${val}px`);
      settings.editor = settings.editor || {};
      settings.editor.fontSize = parseInt(val, 10);
      await writeTextFile('settings.json', JSON.stringify(settings, null, 2), { dir: BaseDirectory.Resource });
    });
    lineHeightInput.addEventListener('input', async e => {
      const val = e.target.value;
      document.documentElement.style.setProperty('--editor-line-height', `${val}px`);
      settings.editor = settings.editor || {};
      settings.editor.lineHeight = parseInt(val, 10);
      await writeTextFile('settings.json', JSON.stringify(settings, null, 2), { dir: BaseDirectory.Resource });
    });

    const ws = new WebSocket('ws://localhost:3000/ws');
    ws.addEventListener('message', ev => {
      try {
        const blocks = JSON.parse(ev.data);
        vc.setBlocks(blocks);
      } catch (e) {
        console.error('invalid ws message', e);
      }
    });

    let currentLang = 'rust';
    let currentLocale = settings.language || 'en';
    vc.setLocale(currentLocale);

    async function parseAndRender() {
      const content = view.state.doc.toString();
      try {
        const blocks = await invoke('parse_blocks', { content, lang: currentLang });
        vc.setBlocks(blocks);
        refreshBlockCount(view);
        updateSearch();
      } catch (e) {
        console.error(e);
      }
    }

    async function initEditor(lang, doc = '') {
      currentLang = lang;
      vc.lang = lang;
      disablePreview();
      if (view) view.destroy();
      if (removeMinimap) removeMinimap();
      if (removeOutline) removeOutline();
      const langSupport = await loadLanguage(lang);
      const spellExt = settings.editor?.spellcheck ? await spellcheck() : [];
      view = new EditorView({
        state: EditorState.create({
          doc,
          extensions: [
            basicSetup,
            drawSelection(),
            editorSizing,
            langSupport || [],
            ...spellExt,
            visualMetaHighlighter,
            visualMetaTooltip,
            visualMetaMessenger,
            activeBlock,
            todoHighlight,
            foldGutter(),
            autocomplete({ override: [customSource] }),
            EditorView.scrollMargins.of(() => ({ top: 20, bottom: 20 })),
            keymap.of(foldKeymap),
            EditorView.updateListener.of(update => {
              if (update.docChanged) {
                parseAndRender();
                updatePreview(update.view);
              }
            })
          ]
        }),
        parent: document.getElementById('editor')
      });
      (globalThis as any).view = view;
      setBlockIds(listMetaIds(view.state.doc.toString()));
      removeMinimap = attachMinimap(view, textMinimapEl);
      removeOutline = attachOutline(view, outlineEl);
      vc.setMetaView(view);
      addBlockToolbar(view, vc, currentLang);
      vc.onBlockMove(async () => {
        await invoke('save_state', { content: view.state.doc.toString() });
      });
      updateTodoPanel(view);
    }

    await initEditor(currentLang);

    document.getElementById('tutorial-start')?.addEventListener('click', () => {
      startTutorial();
    });

      window.openInTextEditor = id => {
      document.getElementById('visual-canvas').style.display = 'none';
      document.getElementById('visual-minimap').style.display = 'none';
      document.getElementById('editor-wrapper').style.height = '90vh';
      if (id) {
        scrollToMeta(id);
      } else {
        const raw = localStorage.getItem(TEXT_CURSOR_KEY);
        if (raw) {
          try {
            const { pos } = JSON.parse(raw);
            if (typeof pos === 'number') {
              view.dispatch({ selection: { anchor: pos }, scrollIntoView: true });
            }
          } catch (_) {}
        }
      }
      view.focus();
    };

    window.openVisualMode = () => {
      const sel = view.state.selection.main;
      localStorage.setItem(TEXT_CURSOR_KEY, JSON.stringify({ pos: sel.anchor }));
      document.getElementById('visual-canvas').style.display = 'block';
      document.getElementById('visual-minimap').style.display = 'block';
      document.getElementById('editor-wrapper').style.height = '40vh';
      vc.draw();
    };

    async function save() {
      await invoke('save_state', { content: view.state.doc.toString() });
      addSnapshot(view);
    }

    async function load() {
      const content = await invoke('load_state');
      view.dispatch({ changes: { from: 0, to: view.state.doc.length, insert: content } });
      parseAndRender();
      foldMetaBlock(view);
    }

    async function openFile(name, content) {
      const lang = languageFromFilename(name);
      const mime = mimeFromFilename(name);
      await initEditor(lang, content || '');
      document.getElementById('editor').dataset.mime = mime;
      if (mime === 'text/markdown' || mime === 'text/html') {
        enablePreview(view, mime);
        updatePreview(view);
      } else {
        disablePreview();
      }
      parseAndRender();
      foldMetaBlock(view);
      setBlockIds(listMetaIds(view.state.doc.toString()));
      if (removeBlame) removeBlame();
      removeBlame = attachGitBlame(view, name);
    }

    window.openFile = openFile;

    async function fetchWatch() {
      try {
        const res = await fetch('/watch');
        const blocks = await res.json();
        if (Array.isArray(blocks) && blocks.length) {
          vc.setBlocks(blocks);
          refreshBlockCount(view);
        }
      } catch (e) {
        console.error('auto-sync failed', e);
      }
    }

    function startAutoSync() {
      const editorCfg = settings?.editor || {};
      if (editorCfg.autoSync) {
        const ms = Math.max(5, editorCfg.autoSyncInterval || 5) * 60000;
        setInterval(fetchWatch, ms);
      }
      const visualCfg = settings?.visual || {};
      if (visualCfg.autoSync) {
        const ms = Math.max(5, visualCfg.autoSyncInterval || 5) * 60000;
        setInterval(fetchWatch, ms);
      }
    }

    async function exportWithoutMeta() {
      exportProgress.style.display = 'inline';
      try {
        await save();
        const path = await saveDialog({ defaultPath: 'code.txt' });
        if (path) {
          await invoke('export_file', { path, stripMeta: true });
        }
      } finally {
        exportProgress.style.display = 'none';
      }
    }

    function exportLayout() {
      const data = JSON.stringify(vc.serialize());
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'layout.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importLayout() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const layout = JSON.parse(ev.target.result);
            vc.load(layout);
          } catch (err) {
            console.error('Invalid layout', err);
          }
        };
        reader.readAsText(file);
      });
      input.click();
    }

    const exportProgress = document.getElementById('export-progress');

    document.getElementById('save').addEventListener('click', save);
    document.getElementById('load').addEventListener('click', load);
    document.getElementById('export-clean').addEventListener('click', exportWithoutMeta);
    document.getElementById('layout-export').addEventListener('click', exportLayout);
    document.getElementById('layout-import').addEventListener('click', importLayout);
    document.getElementById('undo').addEventListener('click', () => vc.undo());
    document.getElementById('redo').addEventListener('click', () => vc.redo());
    document.getElementById('history').addEventListener('click', () => showHistory(view));
    document.getElementById('insert-meta').addEventListener('click', () => {
      insertVisualMeta(view, currentLang);
      foldMetaBlock(view);
    });

    const searchInput = document.getElementById('search-input');
    const searchResultsEl = document.getElementById('search-results');
    const searchRegex = document.getElementById('search-regex');
    const searchWhole = document.getElementById('search-whole');
    let searchResults = [];
    function updateSearch() {
      try {
        searchResults = searchAll(searchInput.value, view, vc.blocksData, currentLocale, {
          regex: searchRegex.checked,
          wholeWord: searchWhole.checked
        });
      } catch (e) {
        console.error(e);
        searchResults = [];
      }
      searchResultsEl.innerHTML = '';
      searchResults.forEach((r, i) => {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = r.type === 'block' ? `Block: ${r.label}` : `Line ${r.line}: ${r.label}`;
        searchResultsEl.appendChild(opt);
      });
      highlightResults(searchResults, view, vc);
    }
    searchInput.addEventListener('input', updateSearch);
    searchRegex.addEventListener('change', updateSearch);
    searchWhole.addEventListener('change', updateSearch);
    searchResultsEl.addEventListener('change', () => {
      const idx = parseInt(searchResultsEl.value, 10);
      const res = searchResults[idx];
      if (res) gotoResult(res, view, vc);
    });

    async function gitCommit() {
      const message = document.getElementById('git-message').value;
      await invoke('git_commit_cmd', { message });
      document.getElementById('git-message').value = '';
      vc.highlightBlocks([]);
      await refreshLog();
    }

    async function showDiff() {
      const diff = await invoke('git_diff_cmd');
      document.getElementById('git-log').textContent = diff;
      highlightDiff(diff);
    }

    async function refreshLog() {
      const log = await invoke('git_log_cmd');
      document.getElementById('git-log').textContent = log.join('\n');
    }

    function highlightDiff(diff) {
      const changed = new Set();
      const regex = /@@ -\d+(?:,\d+)? \+(\d+)(?:,(\d+))? @@/g;
      let m;
      while ((m = regex.exec(diff)) !== null) {
        const start = parseInt(m[1]);
        const count = m[2] ? parseInt(m[2]) : 1;
        for (let i = start; i < start + count; i++) changed.add(i);
      }
      const content = view.state.doc.toString();
      const blocks = vc.blocksData.map(b => {
        const before = content.slice(0, b.range[0]);
        const startLine = before.split('\n').length;
        const blockContent = content.slice(b.range[0], b.range[1]);
        const lines = blockContent.split('\n').length - 1;
        const endLine = startLine + lines;
        return { id: b.visual_id, start: startLine, end: endLine };
      });
      const ids = blocks.filter(b => {
        for (let i = b.start; i <= b.end; i++) if (changed.has(i)) return true;
        return false;
      }).map(b => b.id);
      vc.highlightBlocks(ids);
    }

    document.getElementById('git-commit').addEventListener('click', gitCommit);
    document.getElementById('git-diff').addEventListener('click', showDiff);

    refreshLog();
    startAutoSync();

    parseAndRender();

    // Split view toggle and hotkey
    document.addEventListener('DOMContentLoaded', () => {
      const splitBtn = document.getElementById('split-toggle');
      let splitActive = false;

      function setSplit(active) {
        splitActive = active;
        document.body.classList.toggle('split', active);
        emit('splitModeChange', { active });
      }

      splitBtn.addEventListener('click', () => setSplit(!splitActive));
      window.addEventListener('keydown', e => {
        if (e.ctrlKey && e.key === '\\') {
          e.preventDefault();
          setSplit(!splitActive);
        }
      });

      setSplit(false);
    });
  </script>
</head>
<body>
  <div id="split-container">
    <div id="visualPane">
      <canvas id="visual-canvas"></canvas>
      <canvas id="visual-minimap" width="200" height="150"></canvas>
    </div>
    <div id="textPane">
      <div id="editor-wrapper">
      <div id="editor" data-file-id="current"></div>
      <div id="preview"></div>
      <div id="text-minimap"></div>
      <div id="outline"></div>
      </div>
      <div id="controls">
        <button id="save" data-i18n="save"></button>
        <button id="load" data-i18n="load"></button>
        <button id="export-clean" data-i18n="export_clean"></button>
        <span id="export-progress" style="display:none" data-i18n="exporting"></span>
        <button id="layout-export" data-i18n="export"></button>
        <button id="layout-import" data-i18n="layout_import"></button>
        <button id="undo" data-i18n="undo"></button>
        <button id="redo" data-i18n="redo"></button>
        <button id="history" data-i18n="history"></button>
        <button id="insert-meta" data-i18n="insert_meta"></button>
        <button id="tutorial-start" data-i18n="tutorial_button"></button>
        <select id="theme"></select>
        <select id="locale"></select>
        <label><span data-i18n="font_size"></span>: <input id="font-size" type="range" min="10" max="24" /></label>
        <label><span data-i18n="line_height"></span>: <input id="line-height" type="range" min="14" max="40" /></label>
      </div>
      <div id="search-panel">
        <input id="search-input" data-i18n-placeholder="search_placeholder" />
        <label><input type="checkbox" id="search-regex" /><span data-i18n="search_regex"></span></label>
        <label><input type="checkbox" id="search-whole" /><span data-i18n="search_whole"></span></label>
        <select id="search-results" size="5"></select>
      </div>
      <div id="git-panel">
        <input id="git-message" data-i18n-placeholder="git_message_placeholder" />
        <button id="git-commit" data-i18n="git_commit"></button>
        <button id="git-diff" data-i18n="git_diff"></button>
        <pre id="git-log"></pre>
      </div>
      <div id="todo-panel">
        <select id="todo-list" size="5"></select>
      </div>
    </div>
  </div>
  <button id="split-toggle" style="position:fixed;top:10px;right:10px;" data-i18n="split_view"></button>

</body>
</html>
