<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multicode Editor</title>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #visual-canvas { width: 100%; height: 50vh; border: 1px solid #ccc; display: block; }
    #editor { height: 40vh; border: 1px solid #ccc; }
    #controls { padding: 0.5rem; }
  </style>
  <script type="module">
    import { EditorState } from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.4.0/dist/index.js";
    import { EditorView, basicSetup } from "https://cdn.jsdelivr.net/npm/@codemirror/basic-setup@0.20.0/dist/index.js";
    import { javascript } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-javascript@0.19.7/dist/index.js";
    import { python } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-python@0.19.7/dist/index.js";
    import { rust } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-rust@0.20.2/dist/index.js";
    import { html } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-html@0.19.7/dist/index.js";
    import { css } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-css@0.19.7/dist/index.js";
    import { invoke } from "https://cdn.jsdelivr.net/npm/@tauri-apps/api@1.5.0/tauri.js";
    import { VisualCanvas } from "./visual/canvas.js";

    const canvasEl = document.getElementById('visual-canvas');
    const vc = new VisualCanvas(canvasEl);

    vc.onBlockMove(async block => {
      const content = view.state.doc.toString();
      const updated = await invoke('upsert_meta', { content, meta: { id: block.id, x: block.x, y: block.y } });
      view.dispatch({ changes: { from: 0, to: view.state.doc.length, insert: updated } });
      await invoke('save_state', { content: updated });
    });

    const currentLang = 'rust';

    async function parseAndRender() {
      const content = view.state.doc.toString();
      try {
        const blocks = await invoke('parse_blocks', { content, lang: currentLang });
        vc.setBlocks(blocks);
      } catch (e) {
        console.error(e);
      }
    }

    const view = new EditorView({
      state: EditorState.create({
        doc: '',
        extensions: [
          basicSetup, javascript(), python(), rust(), html(), css(),
          EditorView.updateListener.of(update => {
            if (update.docChanged) parseAndRender();
          })
        ]
      }),
      parent: document.getElementById('editor')
    });

    async function save() {
      await invoke('save_state', { content: view.state.doc.toString() });
    }

    async function load() {
      const content = await invoke('load_state');
      view.dispatch({ changes: { from: 0, to: view.state.doc.length, insert: content } });
      parseAndRender();
    }

    document.getElementById('save').addEventListener('click', save);
    document.getElementById('load').addEventListener('click', load);

    parseAndRender();
  </script>
</head>
<body>
  <canvas id="visual-canvas"></canvas>
  <div id="editor"></div>
  <div id="controls">
    <button id="save">Save</button>
    <button id="load">Load</button>
  </div>
</body>
</html>
