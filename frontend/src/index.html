<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multicode Editor</title>
  <link rel="stylesheet" href="./hotkeys.css" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #visual-canvas { width: 100%; height: 50vh; border: 1px solid #ccc; display: block; }
    #visual-minimap { position: fixed; bottom: 10px; right: 10px; width: 200px; height: 150px; border: 1px solid #ccc; background: #fff; opacity: 0.8; }
    #editor { height: 40vh; border: 1px solid #ccc; }
    #controls { padding: 0.5rem; }
    #git-panel { padding: 0.5rem; border-top: 1px solid #ccc; }
    #git-log { white-space: pre-wrap; background: #f5f5f5; max-height: 20vh; overflow: auto; padding: 0.5rem; }
    .cm-invalid-meta { text-decoration: wavy underline red; }
  </style>
  <script type="module">
    import { EditorState } from "@codemirror/state";
    import { EditorView } from "@codemirror/view";
    import { basicSetup } from "https://cdn.jsdelivr.net/npm/@codemirror/basic-setup@0.20.0/dist/index.js";
    import { javascript } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-javascript@0.19.7/dist/index.js";
    import { python } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-python@0.19.7/dist/index.js";
    import { rust } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-rust@0.20.2/dist/index.js";
    import { html } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-html@0.19.7/dist/index.js";
    import { css } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-css@0.19.7/dist/index.js";
    import { invoke } from "https://cdn.jsdelivr.net/npm/@tauri-apps/api@1.5.0/tauri.js";
    import { save as saveDialog } from "https://cdn.jsdelivr.net/npm/@tauri-apps/api@1.5.0/dialog.js";
    import { VisualCanvas } from "./visual/canvas.js";
    import { loadBlockPlugins } from "./visual/blocks.js";
    import { insertVisualMeta, updateMetaComment, visualMetaHighlighter, visualMetaTooltip } from "./editor/visual-meta.js";
    import { registerHotkeys, setCanvas } from "./visual/hotkeys.ts";

    await loadBlockPlugins(window.blockPlugins || []);

    const canvasEl = document.getElementById('visual-canvas');
    const minimapEl = document.getElementById('visual-minimap');
    const vc = new VisualCanvas(canvasEl, minimapEl);
    setCanvas(vc);
    registerHotkeys();

    const ws = new WebSocket('ws://localhost:3000/ws');
    ws.addEventListener('message', ev => {
      try {
        const blocks = JSON.parse(ev.data);
        vc.setBlocks(blocks);
      } catch (e) {
        console.error('invalid ws message', e);
      }
    });

    vc.onBlockMove(async block => {
      if (updateMetaComment(view, { id: block.id, x: block.x, y: block.y })) {
        await invoke('save_state', { content: view.state.doc.toString() });
      }
    });

    const currentLang = 'rust';
    let currentLocale = 'en';
    vc.setLocale(currentLocale);

    async function parseAndRender() {
      const content = view.state.doc.toString();
      try {
        const blocks = await invoke('parse_blocks', { content, lang: currentLang });
        vc.setBlocks(blocks);
      } catch (e) {
        console.error(e);
      }
    }

    const view = new EditorView({
      state: EditorState.create({
        doc: '',
        extensions: [
          basicSetup, javascript(), python(), rust(), html(), css(), visualMetaHighlighter, visualMetaTooltip,
          EditorView.updateListener.of(update => {
            if (update.docChanged) parseAndRender();
          })
        ]
      }),
      parent: document.getElementById('editor')
    });

    async function save() {
      await invoke('save_state', { content: view.state.doc.toString() });
    }

    async function load() {
      const content = await invoke('load_state');
      view.dispatch({ changes: { from: 0, to: view.state.doc.length, insert: content } });
      parseAndRender();
    }

    async function exportWithoutMeta() {
      exportProgress.style.display = 'inline';
      try {
        await save();
        const path = await saveDialog({ defaultPath: 'code.txt' });
        if (path) {
          await invoke('export_file', { path, stripMeta: true });
        }
      } finally {
        exportProgress.style.display = 'none';
      }
    }

    const exportProgress = document.getElementById('export-progress');

    document.getElementById('save').addEventListener('click', save);
    document.getElementById('load').addEventListener('click', load);
    document.getElementById('export-clean').addEventListener('click', exportWithoutMeta);
    document.getElementById('undo').addEventListener('click', () => vc.undo());
    document.getElementById('redo').addEventListener('click', () => vc.redo());
    document.getElementById('insert-meta').addEventListener('click', () => insertVisualMeta(view, currentLang));
    document.getElementById('locale').addEventListener('change', e => {
      currentLocale = e.target.value;
      vc.setLocale(currentLocale);
    });

    async function gitCommit() {
      const message = document.getElementById('git-message').value;
      await invoke('git_commit_cmd', { message });
      document.getElementById('git-message').value = '';
      vc.highlightBlocks([]);
      await refreshLog();
    }

    async function showDiff() {
      const diff = await invoke('git_diff_cmd');
      document.getElementById('git-log').textContent = diff;
      highlightDiff(diff);
    }

    async function refreshLog() {
      const log = await invoke('git_log_cmd');
      document.getElementById('git-log').textContent = log.join('\n');
    }

    function highlightDiff(diff) {
      const changed = new Set();
      const regex = /@@ -\d+(?:,\d+)? \+(\d+)(?:,(\d+))? @@/g;
      let m;
      while ((m = regex.exec(diff)) !== null) {
        const start = parseInt(m[1]);
        const count = m[2] ? parseInt(m[2]) : 1;
        for (let i = start; i < start + count; i++) changed.add(i);
      }
      const content = view.state.doc.toString();
      const blocks = vc.blocksData.map(b => {
        const before = content.slice(0, b.range[0]);
        const startLine = before.split('\n').length;
        const blockContent = content.slice(b.range[0], b.range[1]);
        const lines = blockContent.split('\n').length - 1;
        const endLine = startLine + lines;
        return { id: b.visual_id, start: startLine, end: endLine };
      });
      const ids = blocks.filter(b => {
        for (let i = b.start; i <= b.end; i++) if (changed.has(i)) return true;
        return false;
      }).map(b => b.id);
      vc.highlightBlocks(ids);
    }

    document.getElementById('git-commit').addEventListener('click', gitCommit);
    document.getElementById('git-diff').addEventListener('click', showDiff);

    refreshLog();

    parseAndRender();
  </script>
</head>
<body>
  <canvas id="visual-canvas"></canvas>
  <canvas id="visual-minimap" width="200" height="150"></canvas>
  <div id="editor"></div>
  <div id="controls">
    <button id="save">Save</button>
    <button id="load">Load</button>
    <button id="export-clean">Экспорт без метаданных</button>
    <span id="export-progress" style="display:none">Exporting…</span>
    <button id="undo">Undo</button>
    <button id="redo">Redo</button>
    <button id="insert-meta">Insert Meta</button>
    <select id="locale">
      <option value="en">English</option>
      <option value="ru">Русский</option>
      <option value="es">Español</option>
    </select>
  </div>
  <div id="git-panel">
    <input id="git-message" placeholder="Commit message" />
    <button id="git-commit">Commit</button>
    <button id="git-diff">Diff</button>
    <pre id="git-log"></pre>
  </div>
</body>
</html>
