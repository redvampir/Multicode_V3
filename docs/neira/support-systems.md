# Поддерживающие системы Neira

## InteractionHub
Единый оркестратор, через который проходят все запросы пользователя. Он регистрирует события, проверяет права доступа и направляет обращения к нужным узлам. InteractionHub агрегирует ответы ActionNode и MemoryNode, связывая их с исходным контекстом и формируя итоговый результат.

```rust
struct InteractionHub {
    sessions: HashMap<SessionId, Context>,
    log: EventLog,
}
```

## TaskScheduler
`TaskScheduler` распределяет задачи по очередям `fast`, `standard` и `long` в зависимости от оценки длительности. AnalysisNode передаёт задачу в соответствующий канал, а Scheduler отвечает за параллелизм и контроль квот, учитывая параметры `priority`, `max_iterations` и `time_slice_ms` каждого узла (см. [«Планировщик и лимиты итераций»](README.md#планировщик-и-лимиты-итераций)).

```toml
[scheduler]
fast = 60_000       # 1 минута
standard = 1_800_000 # 30 минут
long = 28_800_000    # 8 часов
```

- Приоритет задач определяется методом `get_priority()` узлов памяти, который учитывает `QualityMetrics` и `UsageStats`.
- Scheduler периодически пересчитывает приоритеты на основе агрегированной статистики и передаёт обновлённые значения связанным AnalysisNode.

## Feedback Aggregator
Агрегатор собирает сигналы от пользователей и автотестов. Он ведёт единый поток обратной связи, влияющий на приоритеты обслуживания узлов памяти.

```rust
struct FeedbackEntry {
    node_id: NodeId,
    source: FeedbackSource,
    metric: String,
    score: f32,
    timestamp: DateTime<Utc>,
}
```

Поток работы:

1. событие фиксируется как `FeedbackEntry`;
2. агрегатор обновляет `QualityMetrics` и `UsageStats` соответствующего узла памяти;
3. планировщик вызывает `update_priority()` узлов памяти на основании обновлённой статистики.

Подробнее см. разделы [analysis-nodes](analysis-nodes.md) и [memory-nodes](memory-nodes.md).

## Рабочая память
Временное хранилище актуального контекста. Содержит последние сообщения, переменные запроса и результаты промежуточных вычислений. Записи автоматически вытесняются по таймеру или при переполнении лимита.

## Модуль эмоций
Следит за тоном диалога и внутренним состоянием системы. Положительные сигналы усиливают инициативность, негативные — вызывают осторожность и запрос на уточнение. Эмоции не влияют на логику вывода, но помогают выбирать стиль ответа.

## Диалоговая логика
Определяет намерение пользователя и выбирает стиль ответа. Также решает, когда активировать образ Нейры, а когда переключиться на сухой режим.

## Модуль личности
Хранит характеристики персонажа и набор устойчивых фраз. Может быть временно отключён для экономии ресурсов или по запросу пользователя.

## Игровой модуль
Использует игровые сценарии как способ обучения и мотивации. Во время игр анализируются сюжет, актёрская работа и нестандартные ситуации, формируя новые узлы анализа.

## Скептический модуль
Добавляет уточняющие вопросы и проверку фактов. В сухом режиме может отключаться для ускорения работы.

## Уведомления о прогрессе
Для задач класса `standard` и `long` InteractionHub отправляет промежуточные сообщения о ходе выполнения. Scheduler выдаёт процент готовности, который отображается пользователю. После завершения задача помечается в журнале и из рабочей памяти удаляются временные записи.
