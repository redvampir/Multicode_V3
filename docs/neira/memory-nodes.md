# Узлы памяти

## Навигация
- [Обзор Нейры](README.md)
- [Узлы действий](action-nodes.md)
- [Узлы анализа](analysis-nodes.md)
- [Узлы памяти](memory-nodes.md)
- [Архитектура анализа](analysis-architecture.md)
- [Поддерживающие системы](support-systems.md)
- [Личность Нейры](personality.md)
- [Шаблон узла](node-template.md)
- [Политика источников](source-policy.md)

## Оглавление
- [Хранимые данные и методы](#хранимые-данные-и-методы)
- [Приоритизация источников](#приоритизация-источников)
- [Игровой опыт и персонализация](#игровой-опыт-и-персонализация)


Узлы памяти хранят агрегированные показатели качества (`QualityMetrics`) и
статистику использования (`UsageStats`). Они служат прослойкой между узлами
анализа и подсистемами ответа, предоставляя базовую выборку знаний.

Каждый узел памяти хранит единицу знания, связанные метрики и журнал ошибок для последующего анализа.

Метрики формируются [узлами анализа](analysis-nodes.md#оценка-качества);
узлы памяти не вычисляют их самостоятельно, а только агрегируют поступившие
значения.

Перед длительными операциями узлы памяти обязаны проверять `cancel_token` и
сохранять текущие данные в чекпоинты. Это позволяет безопасно возобновлять
работу после прерывания или переноса задачи.

## Хранимые данные и методы

### Структуры

```rust
struct QualityMetrics {
    credibility: f32,    // 0..1
    recency_days: u32,   // возраст данных
    demand: u32,         // число запросов
}

struct UsageStats {
    calls: u64,          // количество обращений
    last_access: u64,    // timestamp последнего обращения
}
```

### Методы

- `update_from_analysis(node_id, QualityMetrics)` — приём метрик от
  Analysis‑узла;
- `get_priority()` — получение текущего приоритета;
- `update_priority()` — пересчёт приоритета с учётом накопленных данных.

## Проверка валидности узлов

Для сохранения качества ответы опираются только на проверенные узлы памяти.
Валидность оценивается в несколько этапов:

### Метрики

- `credibility` и связанные показатели должны превышать минимальные пороги;
  значения ниже 0.3 приводят к отбраковке узла.
- `recency_days` ограничивается верхней границей, что предотвращает
  использование устаревших данных.
- показатели популярности (`demand`, `calls`) помогают выявлять
  редко используемые и, возможно, лишние записи.

### Автоматические тесты

- линтеры и unit‑тесты проверяют целостность структуры узла;
- property‑тесты моделируют типичные сценарии использования и фиксируют
  ошибки в журнале узла.

### Ручная проверка

- модератор просматривает журнал ошибок, подтверждает источник данных и
  при необходимости корректирует объяснение узла;
- спорные записи отправляются на повторный анализ или полностью
  исключаются из базы.

### Примеры обработки некорректных узлов

- **Отбраковка**: `credibility < 0.3` или множество ошибок в журнале — узел
  удаляется вызовом `reject(node_id)` и помечается для повторного сбора данных.
- **Корректировка**: если `recency_days` превышает порог, запрашивается
  актуализация сведений и выполняется `update_from_analysis` с новой
  метрикой; после успешного прогона тестов узел вновь становится активным.

## Приоритизация источников

1. **Узлы памяти** — базовая выборка знаний для чернового ответа.
2. **Внутренние базы** — уточнение и расширение при недостатке данных в памяти.
3. **Внешние ресурсы** — привлечение информации из интернета и сторонних источников.

Оценка каждого источника выполняется по трём критериям:

- **Релевантность** — насколько источник соответствует запросу.
- **Доверие** — степень надежности и проверенности данных.
- **Актуальность** — свежесть информации и наличие обновлений.
 
Итоговый приоритет узла вычисляется из показателей достоверности, актуальности
и востребованности, а также накопленной статистики использования.

```
priority = f(credibility, recency_days, demand)

f(0.9, 2, 50)  -> 0.86
f(0.2, 60, 1)  -> 0.05
```

## Игровой опыт и персонализация
Узлы памяти сохраняют опыт общения с пользователем и данные игровых сессий.
Игровые взаимодействия используются как дополнительный источник обучения: из них выделяются новые факты и создаются вспомогательные узлы.
Система адаптирует стиль общения под пользователя, но базовое ядро личности остаётся неизменным.


## Схемы

JSON‑схемы расположены в каталоге [../../schemas](../../schemas). При несовместимых изменениях повышайте версию: `1.0.0` → `1.1.0`.
