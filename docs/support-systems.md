# Подсистемы поддержки

## Навигация
- [Обзор Нейры](neira/README.md)
- [Узлы действий](neira/action-nodes.md)
- [Узлы анализа](neira/analysis-nodes.md)
- [Узлы памяти](neira/memory-nodes.md)
- [Архитектура анализа](neira/analysis-architecture.md)
- [Поддерживающие системы](neira/support-systems.md)
- [Личность Нейры](neira/personality.md)
- [Шаблон узла](neira/node-template.md)
- [Политика источников](neira/source-policy.md)

## Оглавление
- [Планировщик задач (TaskScheduler)](#планировщик-задач-taskscheduler)
  - [Очереди](#очереди)
  - [Жизненный цикл задачи](#жизненный-цикл-задачи)
  - [Структура задачи](#структура-задачи)
  - [Пороги длительности](#пороги-длительности)
  - [Настройка порогов](#настройка-порогов)
    - [Пример JSON](#пример-json)
    - [Пример YAML](#пример-yaml)
  - [Таймауты и отмена](#таймауты-и-отмена)

## Планировщик задач (TaskScheduler)

`TaskScheduler` распределяет входящие операции по приоритетным очередям и отслеживает их выполнение.

### Очереди

- `high` — критичные запросы, требующие немедленного выполнения.
- `medium` — типовые задачи, обрабатываемые в обычном порядке.
- `low` — фоновая работа, выполняемая при наличии ресурсов.

### Жизненный цикл задачи

`queued → running → completed/failed`

После постановки в очередь задача переходит в состояние `running`, когда назначается исполнителю. Завершившаяся успешно задача получает статус `completed`, при ошибке — `failed`.

### Структура задачи

```rust
struct Task {
    id: String,
    kind: String,
    params: TaskParams,
    timeout_ms: u64,
    node_refs: Vec<NodeId>,
}
```

### Пороги длительности

| Класс     | Максимальное время | Описание |
|-----------|-------------------|----------|
| `fast`    | до 1 мин | Краткие операции, выполняющиеся почти мгновенно. |
| `standard`| до 30 мин | Типичные задачи умеренной сложности. |
| `long`    | до 8 часов | Длительные вычисления, выполняемые в фоне. |

### Настройка порогов

Значения по умолчанию задаются в конфигурации `TaskScheduler`. Разработчик может изменить их, указав новые пределы в конфигурационном файле. Время указывается в миллисекундах.

#### Пример JSON

```json
{
  "thresholds": {
    "fast": 60000,
    "standard": 1800000,
    "long": 28800000
  }
}
```

#### Пример YAML

```yaml
thresholds:
  fast: 60000       # 1 минута
  standard: 1800000 # 30 минут
  long: 28800000    # 8 часов
```

При запуске `TaskScheduler` считывает конфигурацию и использует указанные пороги для распределения задач.

### Таймауты и отмена

Каждая задача имеет собственный `timeout_ms`. Если выполнение превышает этот предел, задача помечается как `failed`, а её ресурсы освобождаются.

```pseudo
cancel(task_id):
    task = find_task(task_id)
    if task.state == running:
        signal_worker_stop(task)
    remove_from_queue(task)
    task.state = failed
```

Явный вызов `cancel` позволяет прерывать задачи до истечения таймаута.
